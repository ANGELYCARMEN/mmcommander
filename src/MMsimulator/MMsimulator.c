/************************************************************************
 *  Medtronic system simulator by Jesus Berian (jesus.berian@gmail.com)
 ************************************************************************/

/*
 * Known issues:
 *       - Pause & resume timer using system time.
 *
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <termios.h>
#include <fcntl.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/time.h>
#include <signal.h>
#include <errno.h>
#include <unistd.h>
#include <time.h>
#include <math.h>

#define PUMPACK_TIMEOUT_MS 2000

void enliteTx (void);
void processRx (char *message, int length);
void printTime (void);
void sendPumpACK (void);
void timer_handler (int);
void timer_sig_handler (int);
void (*timer_func_handler_pntr)(void);
int start_timer(int, void (*)(void));
void pause_timer(void);
void resume_timer(int);
void stop_timer(void);
int kbhit(void);
void getCGMHistoryLine (char *line);
void getHistoryLine (char *line);

char             fdDev     [256]    ;
int              fdMMCommander      ;
int              fdEnliteData       ;
char             txMessage   [4096] ;
char             rxMessage   [4096] ;
char             lastMessage [4096] ;
int              lastLength         ;
int              repTimes           ;
int              rxPointer          ;
int              readBytes          ;
char             pumpID    [3]      ;
char             pumpActive         ;
char             enliteID  [3]      ;
char             enliteData [9*2]   ;
int              enliteWarmupCnt    ;
char             enliteNumSeq       ;
float            enlitePeriod    [8]   = {307, 241, 357, 271, 335, 206, 246, 326};
float            enliteIntPeriod [8]   = { 16,  17,  17,  11,  13,  12,  14,  11};
int              enliteGlucose      ;
int              enliteBeep         ;
char             enliteBatLevel     ;
char             enliteISIGadj      ;
float            enliteDataPhase    ;
char             enliteManualMode   ;
char             enliteOutOfRange   ;
char             glucometerID[3]    ;
char             glucometerActive   ;
int              glucometerValue    ;
char             firstTime          ;
char             lastCommand        ;
char             enliteActive       ;
int              cmdRep             ;
char             cgmHistoryEnable   ;
char             cgmHistoryReading  ;
int              cgmHistoryPage     ;
int              cgmHistoryLine     ;
char             historyEnable      ;
char             historyReading     ;
int              historyPage        ;
int              historyLine        ;
int              timerActive        ;
int              mySentrySyncOn     ;
int              mySentryActive     ;
char             mySentryID  [3]    ;
struct itimerval timervalue         ;
struct itimerval timervalue2        ;
float            time2enlite        ;
float            timerTimeLeft      ;
struct itimerval timervalueP        ;
struct sigaction new_handler        ;
struct sigaction old_handler        ;

int main(int argc, char **argv)
{

  struct termios   tty                ;
  int              param              ;
  float            paramf             ;
  int              i                  ;
  int              continueProcessing ;
  int              c                  ;
  unsigned int     msgLength          ;

  if (argc < 2) {    
    printf("\n  Usage: %s [MMCommander_dev] <parameters>\n\n",argv[0]);;
    printf("     Parameters: -p  [pumpID]       -> Pump to be simulated.\n");
    printf("                 -e  [enliteID]     -> Enlite transmitter to be simulated.\n");
    printf("                 -g  [glucometerID] -> Glucometer to be simulated.\n");
    printf("                 -m  [mySentryID]   -> MySentry to be simulated.\n");
    printf("                 -n  [minutes]      -> Enable new sensor mode.\n");
    printf("                 -i  [glucose]      -> Force Enlite simulator to a fixed glucose value.\n\n");
    return(-1);
  }

  // Init text
  printf("\n ----------------------------------------------------------------------------------------\n");
  printf(" |                                                                                      |\n");
  printf(" | Medtronic system simulator.   v0.104                                                 |\n");
  printf(" |                                                                                      |\n");
  printf(" |                                           Jesus Berian (jesus.berian@gmail.com)      |\n");
  printf(" |                                                                                      |\n");
  printf(" ----------------------------------------------------------------------------------------\n\n");

  // Init variables
  pumpID[0]       = 0x00;
  pumpID[1]       = 0x00;
  pumpID[2]       = 0x00;
  pumpActive      = 0;
  enliteID[0]     = 0x00;
  enliteID[1]     = 0x00;
  enliteID[2]     = 0x00;
  glucometerID[0] = 0x00;
  glucometerID[1] = 0x00;
  glucometerID[2] = 0x00;
  glucometerActive = 0;
  mySentrySyncOn   = 0;
  mySentryActive   = 0;
  mySentryID[0]   = 0x00;
  mySentryID[1]   = 0x00;
  mySentryID[2]   = 0x00;
  enliteOutOfRange = 0;
  enliteActive    = 0;
  enliteWarmupCnt = 0;
  enliteGlucose   = -1;
  enliteBeep      = 0;
  enliteBatLevel  = 0x60;
  enliteISIGadj   = 0x21;
  enliteDataPhase = 0.0;
  enliteNumSeq    = 0;
  time2enlite     = 0.0;
  firstTime       = 0;
  rxPointer       = 0;
  lastCommand     = 0;
  cmdRep          = 0;
  cgmHistoryEnable   = 0;
  cgmHistoryReading  = 0;
  cgmHistoryPage     = 0;
  cgmHistoryLine     = 0;
  timerActive     = 0;
  for (i=0; i<9*2; i++) enliteData[i] = 0x00;
  for (i=0; i<4096; i++) lastMessage[i] = 0x00;
  lastLength      = 0;
  repTimes        = 1;

  strcpy(fdDev,argv[1]);

  // Get parameters
  while ((c = getopt (argc, argv, "m:p:e:n:g:i:")) != -1)
    switch (c)
      {
      case 'p':
        sscanf(optarg,"%X",&param);
	pumpID[0]   = (char)( param        & 0x000000FF);
	pumpID[1]   = (char)((param >>  8) & 0x000000FF);
	pumpID[2]   = (char)((param >> 16) & 0x000000FF);
	pumpActive  = 1;
	printf(" - Paradigm Veo 754 Pump simulated : %.2X%.2X%.2X\n",
           (pumpID[2]&0x00FF),(pumpID[1]&0x00FF),(pumpID[0]&0x00FF));
	break;
      case 'm':
        sscanf(optarg,"%X",&param);
	mySentryID[0]   = (char)( param        & 0x000000FF);
	mySentryID[1]   = (char)((param >>  8) & 0x000000FF);
	mySentryID[2]   = (char)((param >> 16) & 0x000000FF);
	mySentryActive  = 1;
	printf(" - MySentry simulated : %.2X%.2X%.2X\n",
           (mySentryID[2]&0x00FF),(mySentryID[1]&0x00FF),(mySentryID[0]&0x00FF));
	break;
      case 'g':
        sscanf(optarg,"%X",&param);
	glucometerID[0] = (char)( param        & 0x000000FF);
	glucometerID[1] = (char)((param >>  8) & 0x000000FF);
	glucometerID[2] = (char)((param >> 16) & 0x000000FF);
	glucometerActive = 1;
	printf(" - Glucometer simulated : %.2X%.2X%.2X",
           (glucometerID[2]&0x00FF),(glucometerID[1]&0x00FF),(glucometerID[0]&0x00FF));
	printf(" - Press 'g' or 'G' to enter a glucose reading.\n");
	break;
      case 'e':
        sscanf(optarg,"%d",&param);
	enliteID[0]   = (char)( param        & 0x000000FF);
	enliteID[1]   = (char)((param >>  8) & 0x000000FF);
	enliteID[2]   = (char)((param >> 16) & 0x000000FF);
	enliteActive  = 1;	
	printf(" - Enlite sensor simulation active : %d (%.2X%.2X%.2X)\n", param,
	       (enliteID[2]&0x00FF),(enliteID[1]&0x00FF),(enliteID[0]&0x00FF));
	printf(" - Press 'o' or 'O' to enable/disable the Enlite Out-Of-Range Mode.\n");
	break;
      case 'n':
        sscanf(optarg,"%f",&paramf);
	paramf += 0.5;
        enliteWarmupCnt = (int)(floor(paramf/5.0));
	printf(" - New sensor simulation active for %.2f minutes.\n",paramf);
	break;
      case 'i':
	sscanf(optarg,"%d",&enliteGlucose);
	printf(" - Glucose value simulated: %d mg/dl\n",enliteGlucose);
	break;
      }

  // Open serial port
  fdMMCommander = open(fdDev,O_RDWR | O_NOCTTY | O_SYNC);
  if (fdMMCommander < 0) {
    printf("\n [ERROR] %s could not be opened.\n\n",fdDev);
    return(-2);
  }
  
  // Set serial port configuration
  if (tcgetattr (fdMMCommander, &tty) != 0) {
    printf("\n [ERROR] MMCommander init: Error from tcgetattr.\n\n");
    close(fdMMCommander);
    return(-3);
  }

  cfsetospeed (&tty, B57600);
  cfsetispeed (&tty, B57600);
  tty.c_cflag = (tty.c_cflag & ~CSIZE) | CS8;
  tty.c_iflag &= ~IGNBRK;
  tty.c_lflag = 0;
  tty.c_oflag = 0;
  tty.c_cc[VMIN] = 0;
  tty.c_cc[VTIME] = 5;
  tty.c_iflag &= ~(IXON | IXOFF | IXANY);
  tty.c_cflag |= (CLOCAL | CREAD);
  tty.c_cflag &= ~(PARENB | PARODD);
  tty.c_cflag |= 0;
  tty.c_cflag &= ~CSTOPB;
  tty.c_cflag &= ~CRTSCTS;

  if (tcsetattr (fdMMCommander, TCSANOW, &tty) != 0) {
    printf("\n [ERROR] Error init tty.\n\n");
    close(fdMMCommander);
    return(-4);
  }

  // Send "Disable TX filter command" to test the interface
  txMessage[0] = 0x03;
  write(fdMMCommander, txMessage, 1);
  sleep(0.5);
  readBytes = read(fdMMCommander, rxMessage, 256);  
  if ((readBytes < 1) || ((rxMessage[0] != 0x03) && (rxMessage[0] != 0x13))) {
    printf("\n [ERROR] No MMCommander found.\n\n");
    close(fdMMCommander);
    return(-5);
  } else {
    printf(" - MMCommander found and ready.\n");
  }

  // Start timer to transmit Enlite data frames   
  if (enliteActive == 1) {
    if(start_timer(30*1000, &enliteTx))
    {
      printf("\n [ERROR] Timer error\n\n");
      return(-6);
    }
  }

  // Report simulation mode
  if ((mySentryActive == 1) || (pumpActive == 1) || (enliteActive == 1)) {  
    printf("\n - REMEMBER TO DISABLE THE TX FILTER!\n");
  } else {
    printf(" - Sniffer mode.\n");
  }

  printf("\n");

  // RX Loop
  while(1) {
    while (kbhit()) {
      fflush(stdout);
      c = getchar();
      switch(c) {
      case 'g':
      case 'G':
	if (glucometerActive == 1) {
	  pause_timer();
	  printf("\b \n - Enter glucose value in mg/dl: ");
          scanf("%d",&glucometerValue);
	  txMessage[0] = 0x81;
	  txMessage[1] = 0x06;
	  txMessage[2] = 0xFF;
	  txMessage[3] = 0xA5;
	  txMessage[4] = glucometerID[2];
	  txMessage[5] = glucometerID[1];
	  txMessage[6] = glucometerID[0];
	  txMessage[7] = (glucometerValue >> 8) & 0x00FF;
	  txMessage[8] = glucometerValue & 0x00FF;
	  printf("\n");
          printTime();
          printf(" TX : ");
          for (i=3; i<9; i++) printf("%.2X ",txMessage[i]&0x00FF);
          printf("XX - (255 times)\n");
          write(fdMMCommander, txMessage, 9); 
	  sleep(4);
	  txMessage[2] = 0x01;
	  txMessage[7] = 0x06;
	  txMessage[8] = 0x00;
          printTime();
          printf(" TX : ");
          for (i=3; i<9; i++) printf("%.2X ",txMessage[i]&0x00FF);
          printf("XX\n");
	  write(fdMMCommander, txMessage, 9);
	  sleep(0.5);
	  resume_timer(4500);
	}
	break;
      case 'o':
      case 'O':
	printf("\b \b");
        if (enliteActive == 1) {
          printTime();
          if (enliteOutOfRange == 0) {
	    printf(" Enlite Out-Of-Range Mode turned ON\n");
	    enliteOutOfRange = 1;
	  } else {
	    printf(" Enlite Out-Of-Range Mode turned OFF\n");
	    enliteOutOfRange = 0;
	  }
	}
	break;
      case 0x0D:
      case 0x0A:
	break;
      default:
	printf("\b \b");
	break;
      }
    }
    readBytes = read(fdMMCommander, &rxMessage[rxPointer], 1024-rxPointer);
    if (readBytes > 0) {
      if (readBytes > 1024) printf("\n\n OOOooopsss!!!!! I've read more than 1024 bytes. We may have a problem.\n\n");
      rxPointer += readBytes;
      continueProcessing = 1;
      while (continueProcessing == 1) {
        continueProcessing = 0;
	msgLength = (rxMessage[1] & 0x00FF);
	if (((rxMessage[0] == 0x02) || (rxMessage[0] == 0x82)) && (msgLength > 74)) {
	  printf("\n\n \033[1;31m UNEXPECTED LARGE MESSAGE - CAUTION - msgLength: %u.\033[0m\n\n\n",msgLength);
	}
        if (rxMessage[0] == 0x03) {
          printTime();
          printf (" CTRL : 03 - Transmission filter enabled.\n");
          for (i=0; i<rxPointer-1; i++) rxMessage[i] = rxMessage[i+1];
          rxPointer--;
          if (rxPointer > 0) continueProcessing = 1;
        } else if (rxMessage[0] == 0x13) {
	  printTime();
          printf (" CTRL : 13 - Transmission filter disabled - \033[1;31mWARNING\033[0m.\n");
          for (i=0; i<rxPointer-1; i++) rxMessage[i] = rxMessage[i+1];
          rxPointer--;
          if (rxPointer > 0) continueProcessing = 1;
        } else if ((rxMessage[0] == 0x01) && (rxPointer > 2)) {
	  printTime();
   	  printf (" CTRL : %.2X %.2X %.2X", rxMessage[0] & 0x00FF,
   		  rxMessage[1] & 0x00FF, rxMessage[2] & 0x00FF); 
          if ((rxMessage[1] == 0x00)  && (rxMessage[2] == 0x00)) {
	    printf(" - \033[1;31mMessage filtered\033[0m.\n");
	  } else {
	    printf(" - Message transmitted.\n");
	  }
          for (i=0; i<rxPointer-3; i++) rxMessage[i] = rxMessage[i+3];
          rxPointer -= 3;
          if (rxPointer > 0) continueProcessing = 1;
        } else if (((rxMessage[0]&0x00FF) == 0x0081) && (rxPointer > 2)) {
	  printTime();
   	  printf (" CTRL : %.2X %.2X %.2X", rxMessage[0] & 0x00FF,
   		  rxMessage[1] & 0x00FF, rxMessage[2] & 0x00FF); 
          if ((rxMessage[1] == 0x00)  && (rxMessage[2] == 0x00)) {
	    printf(" - \033[1;31mMessage filtered\033[0m.\n");
	  } else {
	    printf(" - Message transmitted appending CRC-8.\n");
	  }
          for (i=0; i<rxPointer-3; i++) rxMessage[i] = rxMessage[i+3];
          rxPointer -= 3;
          if (rxPointer > 0) continueProcessing = 1;
	} else if (((rxMessage[0]&0x00FF) == 0x00C1) && (rxPointer > 2)) {
	  printTime();
      	  printf (" CTRL : %.2X %.2X %.2X", rxMessage[0] & 0x00FF,
   		  rxMessage[1] & 0x00FF, rxMessage[2] & 0x00FF); 
          if ((rxMessage[1] == 0x00)  && (rxMessage[2] == 0x00)) {
	    printf(" - \033[1;31mMessage filtered\033[0m.\n");
	  } else {
	    printf(" - Message transmitted appending CRC-16.\n");
	  }
          for (i=0; i<rxPointer-3; i++) rxMessage[i] = rxMessage[i+3];
          rxPointer -= 3;
          if (rxPointer > 0) continueProcessing = 1;
        } else if (((rxMessage[0]&0x00FF) == 0x0082) && (rxPointer > 1) && (rxPointer >= msgLength+2)) {
	  memcpy(lastMessage,rxMessage,msgLength+2);
	  lastLength = msgLength;
	  repTimes = 1;
	  printTime();
	  if (rxMessage[1] > 0 ) {
	    printf (" RX : ");
	    for (i=2; i< rxMessage[1]+2; i++) printf("%.2X ",rxMessage[i]&0x00FF);
	    printf ("- CRC ERROR");
	    if (((rxMessage[2]&0x00FF == 0x00AA) || (rxMessage[2]&0x00FF == 0x00AB)) &&
		(enliteBeep == 1)) Beep(587,500);
	    printf("\n");
	  } else {
            printf (" RX : \033[1;31mNull message - This situation shouldn't happen\033[0m. - CRC ERROR\n");
	  }
          param = ( msgLength + 2 ) & 0x00FF ;
          for (i=0; i<(rxPointer-param); i++) rxMessage[i] = rxMessage[i+param];
          rxPointer -= param;
          if (rxPointer > 0) continueProcessing = 1; 
        } else if ((rxMessage[0] == 0x02) && (rxPointer > 1) && (rxPointer >= msgLength+2)) {
	  memcpy(lastMessage,rxMessage,msgLength+2);
	  lastLength = msgLength;
	  repTimes = 1;
	  printTime();
	  if (rxMessage[1] > 0) {
            printf (" RX : ");
            for (i=2; i<msgLength+2; i++) printf("%.2X ",rxMessage[i]&0x00FF);
	    if (((rxMessage[2]&0x00FF == 0x00AA) || (rxMessage[2]&0x00FF == 0x00AB)) &&
		(enliteBeep == 1)) Beep(587,500);
            printf ("\n");
            if ((pumpActive == 1) || (mySentryActive == 1)) processRx ( &rxMessage[2] , (int)(msgLength));
	  } else {
            printf (" RX : \033[1;31mNull message - This situation shouldn't happen\033[0m.\n");
	  }
          param = ( msgLength + 2 ) &0x00FF ;
          for (i=0; i<(rxPointer-param); i++) rxMessage[i] = rxMessage[i+param];
          rxPointer -= param;
          if (rxPointer > 0) continueProcessing = 1;
	} else if (rxMessage[0] == 0x04) {
	  repTimes++;
	  printTime();
	  if (lastMessage[1] > 0) {
            printf (" RX : ");
            for (i=2; i<lastLength+2; i++) printf("%.2X ",lastMessage[i]&0x00FF);
	    if ((lastMessage[0] & 0x00FF) == 0x0082) printf("- CRC ERROR ");
	    printf("- Repeated %d times",repTimes);
	    if (((lastMessage[2]&0x00FF == 0x00AA) || (lastMessage[2]&0x00FF == 0x00AB)) &&
		(enliteBeep == 1)) Beep(587,500);
            printf ("\n");
            if ((pumpActive == 1) || (mySentryActive == 1)) processRx ( &lastMessage[2] , (int)(lastLength));
	  } else {
            printf (" RX : \033[1;31mNull message - This situation shouldn't happen\033[0m.");
	    if ((lastMessage[0] & 0x00FF) == 0x0082) printf(" - CRC ERROR");
	    printf("\n");
	  }
          param = 1;
          for (i=0; i<(rxPointer-param); i++) rxMessage[i] = rxMessage[i+param];
          rxPointer -= param;
          if (rxPointer > 0) continueProcessing = 1;
	  
	} else if ( (rxMessage[0] != 0x04) && (rxMessage[0] != 0x03) && (rxMessage[0] != 0x13) && (rxMessage[0] != 0x01) &&
                    ((rxMessage[0]&0x00FF) != 0x0081) && ((rxMessage[0]&0x00FF) != 0x00C1) && 
                    (rxMessage[0] != 0x02) && ((rxMessage[0]&0x00FF) != 0x0082)) {
	  printTime();
          printf (" UNKNOWN : %.2X\n",rxMessage[0] & 0x00FF );
          for (i=0; i<rxPointer-1; i++) rxMessage[i] = rxMessage[i+1];
          rxPointer--;

          if (rxPointer > 0) continueProcessing = 1;
	} 
	fflush(stdout);
	if (rxPointer < 0) {
	  printf("\n\n \033[1;31m NEGATIVE RXPOINTER - CAUTION - rxPointer: %d - Reseting to 0.\033[0m\n\n\n",rxPointer);
	  rxPointer = 0;
	}
      }
    }
    sleep(0.5);
  }

  stop_timer();
  close(fdMMCommander);

  return(0);
}

void enliteTx(void)
{
  int newISIG;
  int i;
  float newGlucose;
  float enliteTimer;
  char  enliteTxMessage [4096] ;

  // Reset timer
  enliteTimer = (enlitePeriod[enliteNumSeq] + enliteIntPeriod[enliteNumSeq]) * 1000.0;
  start_timer((int)enliteTimer, &enliteTx);
  time2enlite = 0.0;

  // Populate data if first time
  if (firstTime == 0) {
    if (enliteGlucose < 0) {
      for (i=8; i>=0; i--) {
	newGlucose = 110 + 10*sin(enliteDataPhase);
	enliteDataPhase += 2*3.14159265359/12;
	if (enliteDataPhase >= 2*3.14159265359) enliteDataPhase -= 2*3.14159265359;
	newISIG = (int)(round(newGlucose * 166.0 / 4.0)) & 0x0000FFFF;
	enliteData[i*2+1] = (char)( newISIG       & 0x000000FF);
        enliteData[i*2  ] = (char)((newISIG >> 8) & 0x000000FF);
      }
    } else {
      for (i=0; i< 9*2; i=i+2) enliteData[i]=(newISIG>>8)&0x00FF;   
      for (i=1; i< 9*2; i=i+2) enliteData[i]=(newISIG)&0x00FF;
    }
    firstTime = 1;   
  }

  // Get new ISIG and add it to the data;
  if (enliteGlucose < 0) {
    newGlucose = 110 + 40*sin(enliteDataPhase);
    enliteDataPhase += 2*3.14159265359/12;
    if (enliteDataPhase >= 2*3.14159265359) enliteDataPhase -= 2*3.14159265359;
  } else {
    newGlucose = enliteGlucose;
  }
  newISIG = (int)(round(newGlucose * 166.0 / 4.0)) & 0x0000FFFF;

  for (i=(9*2-1); i>1; i--) enliteData[i] = enliteData[i-2];
  enliteData[1] = (char)( newISIG       & 0x000000FF);
  enliteData[0] = (char)((newISIG >> 8) & 0x000000FF);

  // Transmit a 32 bytes length message once adding CRC-16 at the end
  enliteTxMessage[0]  = 0xC1;
  enliteTxMessage[1]  = 0x20;
  enliteTxMessage[2]  = 0x01;

  // Enlite message
  if (enliteWarmupCnt == 0) {
    enliteTxMessage[3] = 0xAB;                                   // State: Normal
  } else {
    enliteTxMessage[3] = 0xAA;                                   // State: Warm-up
    enliteWarmupCnt--;
  }
  enliteTxMessage[4]  = 0x0F;                                    // Some flags I suppose: If you change ...
                                                                 //  it the pump won't respond to the message.

  enliteTxMessage[5]  = enliteID[2];                             // ---
  enliteTxMessage[6]  = enliteID[1];                             //  | Enlite ID
  enliteTxMessage[7]  = enliteID[0];                             // ---

  enliteTxMessage[8]  = 13;                                      // Version: 1 Revision: 3
  enliteTxMessage[9]  = 0x1D;                                    // Unknown
  enliteTxMessage[10] = enliteISIGadj;                           // ISIG adjustment value
  enliteTxMessage[11] = (enliteNumSeq << 4) & 0xF0;              // Sequence number

  for (i=0; i<4; i++) enliteTxMessage[12+i] = enliteData[i];     // Recent ISIG data
  enliteTxMessage[16] = 0x00;                                    // Unknown but if 0x02 = Change sensor 
  enliteTxMessage[17] = 0x67;                                    // Unknown - but 0x00 when "Sensor Error"
  enliteTxMessage[18] = 0x67;                                    // Last byte 17. Unknown. 0x00 when "Sensor Error"
  enliteTxMessage[19] = 0x9D;                                    // Battery level
  for (i=4; i<9*2; i++) enliteTxMessage[20+i-4] = enliteData[i]; // More past ISIG data
  enliteTxMessage[34] = 0x00;                                    // Padding (CRC-16)

  printTime();
  printf(" TX : ");
  for (i=3; i<35; i++) printf("%.2X ",enliteTxMessage[i]&0x00FF);
  printf("XX XX");

  if (enliteOutOfRange == 0) {
    write(fdMMCommander, enliteTxMessage, 35); 
    printf("\n");
  } else {
    printf(" - \033[1;31mOut Of Range\033[0m\n");
  }

  // Wait 17-seq seconds and retransmit incrementing modified sequence number
  sleep((int)enliteIntPeriod[enliteNumSeq]);
 
  enliteTxMessage[11] += 1;
 
  printTime();
  printf(" TX : ");
  for (i=3; i<35; i++) printf("%.2X ",enliteTxMessage[i]&0x00FF);
  printf("XX XX");

  if (enliteOutOfRange == 0) {
    write(fdMMCommander, enliteTxMessage, 35); 
    printf("\n");
  } else {
    printf(" - \033[1;31mOut Of Range\033[0m\n");
  }

  // Increment real sequence number for the next time. Modulus 8. 
  if (++enliteNumSeq == 8) enliteNumSeq = 0;

  // Decrement battery level
  if (--enliteBatLevel == 0) enliteBatLevel = 0x60; 
}

void processRx (char *message, int length)
{
  int command;
  int i;
  int txLen;
  float realTime;

  if (mySentryActive == 1) {
    if ((message[0]&0x00FF) == 0xA2) {
    if ((message[4] & 0x00FF) == 0x09) {
      pause_timer();
      mySentrySyncOn = 1;
      txMessage[0] = 0x81;
      txMessage[1] = 0x0E;
      txMessage[2] = 0x01;
      txMessage[3] = 0xA2;
      txMessage[4] = message[1];
      txMessage[5] = message[2];
      txMessage[6] = message[3];
      txMessage[7] = 0x06;
      txMessage[8] = message[5] & 0x7F;
      txMessage[9]  = mySentryID[2];
      txMessage[10] = mySentryID[1];
      txMessage[11] = mySentryID[0];
      txMessage[12] = 0x00;
      txMessage[13] = message[4];
      txMessage[14] = 0x00;
      txMessage[15] = 0x00;
      txMessage[16] = 0x00;
      txLen = 17;
      write(fdMMCommander, txMessage, txLen);
      printTime();
      printf (" TX : ");
      for (i=3; i< txLen; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
      printf ("XX \n");
      fflush(stdout);
      resume_timer(5);
    } else if ( ((message[4] & 0x00FF) == 0x0A) &&
                (mySentrySyncOn == 1)) {
      pause_timer();
      txMessage[0] = 0x81;
      txMessage[1] = 0x0E;
      txMessage[2] = 0x01;
      txMessage[3] = 0xA2;
      txMessage[4] = message[1];
      txMessage[5] = message[2];
      txMessage[6] = message[3];
      txMessage[7] = 0x06;
      txMessage[8] = message[5] & 0x7F;
      txMessage[9]  = mySentryID[2];
      txMessage[10] = mySentryID[1];
      txMessage[11] = mySentryID[0];
      txMessage[12] = 0x00;
      txMessage[13] = message[4];
      txMessage[14] = 0x08;
      txMessage[15] = 0x00;
      txMessage[16] = 0x00;
      txLen = 17;
      write(fdMMCommander, txMessage, txLen);
      printTime();
      printf (" TX : ");
      for (i=3; i< txLen; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
      printf ("XX \n");
      fflush(stdout);
      resume_timer(5);
    } else if (((message[4] & 0x00FF) == 0x08)  &&
	       (mySentrySyncOn == 1)) {
      pause_timer();
      txMessage[0] = 0x81;
      txMessage[1] = 0x0E;
      txMessage[2] = 0x01;
      txMessage[3] = 0xA2;
      txMessage[4] = message[1];
      txMessage[5] = message[2];
      txMessage[6] = message[3];
      txMessage[7] = 0x06;
      txMessage[8] = message[5] & 0x7F;
      txMessage[9]  = mySentryID[2];
      txMessage[10] = mySentryID[1];
      txMessage[11] = mySentryID[0];
      txMessage[12] = 0x00;
      txMessage[13] = message[4];
      txMessage[14] = 0x04;
      txMessage[15] = 0x00;
      txMessage[16] = 0x00;
      txLen = 17;
      write(fdMMCommander, txMessage, txLen);
      printTime();
      printf (" TX : ");
      for (i=3; i< txLen; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
      printf ("XX \n");
      fflush(stdout);
      resume_timer(5);
    } else if (((message[4] & 0x00FF) == 0x04)  &&
	       (mySentrySyncOn == 1)) {
      pause_timer();
      txMessage[0] = 0x81;
      txMessage[1] = 0x0E;
      txMessage[2] = 0x01;
      txMessage[3] = 0xA2;
      txMessage[4] = message[1];
      txMessage[5] = message[2];
      txMessage[6] = message[3];
      txMessage[7] = 0x06;
      txMessage[8] = message[5] & 0x7F;
      txMessage[9]  = mySentryID[2];
      txMessage[10] = mySentryID[1];
      txMessage[11] = mySentryID[0];
      txMessage[12] = 0x00;
      txMessage[13] = message[4];
      txMessage[14] = 0x0B;
      txMessage[15] = 0x00;
      txMessage[16] = 0x00;
      txLen = 17;
      write(fdMMCommander, txMessage, txLen);
      printTime();
      printf (" TX : ");
      for (i=3; i< txLen; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
      printf ("XX \n");
      fflush(stdout);
      resume_timer(5);
    } else if ( ((message[4] & 0x00FF) == 0x0B)  &&
                (mySentrySyncOn == 1)) {
      pause_timer();
      mySentrySyncOn = 0;
      txMessage[0] = 0x81;
      txMessage[1] = 0x0E;
      txMessage[2] = 0x01;
      txMessage[3] = 0xA2;
      txMessage[4] = message[1];
      txMessage[5] = message[2];
      txMessage[6] = message[3];
      txMessage[7] = 0x06;
      txMessage[8] = message[5] & 0x7F;
      txMessage[9]  = mySentryID[2];
      txMessage[10] = mySentryID[1];
      txMessage[11] = mySentryID[0];
      txMessage[12] = 0x00;
      txMessage[13] = message[4];
      txMessage[14] = 0x00;
      txMessage[15] = 0x00;
      txMessage[16] = 0x00;
      txLen = 17;
      write(fdMMCommander, txMessage, txLen);
      printTime();
      printf (" TX : ");
      for (i=3; i< txLen; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
      printf ("XX \n");
      fflush(stdout);
      resume_timer(5);
    } 
  }  
  } else if ( ((message[0]&0x00FF) == 0xA7) && 
               ((message[1]&0x00FF) == (pumpID[2]&0x00FF)) &&
               ((message[2]&0x00FF) == (pumpID[1]&0x00FF)) && 
               ((message[3]&0x00FF) == (pumpID[0]&0x00FF)) ) {

    if (message[4] != lastCommand) cmdRep = 0;
    else cmdRep++;

    command = (message[4] & 0x00FF);

    switch(command) {
    case 0x0006:
      if ((cgmHistoryReading == 1) && 
          (length == 7)) {
	pause_timer();
	sleep(0.5);
	txMessage[0] = 0x81;
	txMessage[1] = 0x46;
	txMessage[2] = 0x01;
	txMessage[3] = 0xA7;
	txMessage[4] = pumpID[2];
	txMessage[5] = pumpID[1];
	txMessage[6] = pumpID[0];
	txMessage[7] = 0x9A;
	getCGMHistoryLine(&txMessage[8]);
	if ((txMessage[8]&0x00FF) == 0x0090) {
	  cgmHistoryEnable = 0;
	  cgmHistoryReading = 0;
	  cgmHistoryPage = 0;
	  cgmHistoryLine = 0;
	}
	txLen = 73;
	for (i=txLen; i<74; i++) txMessage[i] = 0x00;
	write(fdMMCommander, txMessage, txLen);
	printTime();
	printf (" TX : ");
	for (i=3; i< txLen; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
	printf ("XX \n");
	fflush(stdout);
	resume_timer(5);
      } else if ((historyReading == 1) && 
          (length == 7)) {
	pause_timer();
	sleep(0.5);
	txMessage[0] = 0x81;
	txMessage[1] = 0x46;
	txMessage[2] = 0x01;
	txMessage[3] = 0xA7;
	txMessage[4] = pumpID[2];
	txMessage[5] = pumpID[1];
	txMessage[6] = pumpID[0];
	txMessage[7] = 0x80;
	getHistoryLine(&txMessage[8]);
	if ((txMessage[8]&0x00FF) == 0x0090) {
	  historyEnable = 0;
	  historyReading = 0;
	  historyPage = 0;
	  historyLine = 0;
	}
	txLen = 73;
	for (i=txLen; i<74; i++) txMessage[i] = 0x00;
	write(fdMMCommander, txMessage, txLen);
	printTime();
	printf (" TX : ");
	for (i=3; i< txLen; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
	printf ("XX \n");
	fflush(stdout);
	resume_timer(5);
      }
      break;
    case 0x005D:
      getitimer(ITIMER_REAL,&timervalue2);
      if (time2enlite == 0.0)
        time2enlite  = (float)(timervalue2.it_value.tv_sec) + ((float)(timervalue2.it_value.tv_usec)/1000000.0);
      start_timer(PUMPACK_TIMEOUT_MS, &sendPumpACK);
      break;
    case 0x008D:
      pause_timer();
      txMessage[0] = 0x81;
      txMessage[1] = 0x46;
      txMessage[2] = 0x01;
      txMessage[3] = 0xA7;
      txMessage[4] = pumpID[2];
      txMessage[5] = pumpID[1];
      txMessage[6] = pumpID[0];
      txMessage[7] = 0x8D;
      txMessage[8] = 0x09;
      txMessage[9] = 0x03;
      txMessage[10] = 0x37;
      txMessage[11] = 0x35;
      txMessage[12] = 0x34;
      for (i=13; i<74; i++) txMessage[i] = 0x00;
      write(fdMMCommander, txMessage, 73);
      printTime();
      printf (" TX : ");
      for (i=3; i< 73; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
      printf ("XX \n");
      fflush(stdout);
      sleep(0.5);
      resume_timer(500);
      break;
    case 0x0075:
      pause_timer();
      txMessage[0] = 0x81;
      txMessage[1] = 0x46;
      txMessage[2] = 0x01;
      txMessage[3] = 0xA7;
      txMessage[4] = pumpID[2];
      txMessage[5] = pumpID[1];
      txMessage[6] = pumpID[0];
      txMessage[7] = 0x75;
      txMessage[8] = 0x01;
      for (i=9; i<74; i++) txMessage[i] = 0x00;
      write(fdMMCommander, txMessage, 73);
      printTime();
      printf (" TX : ");
      for (i=3; i< 73; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
      printf ("XX \n");
      fflush(stdout);
      sleep(0.5);
      resume_timer(500);
      break;
    case 0x0083:
      pause_timer();
      txMessage[0] = 0x81;
      txMessage[1] = 0x46;
      txMessage[2] = 0x01;
      txMessage[3] = 0xA7;
      txMessage[4] = pumpID[2];
      txMessage[5] = pumpID[1];
      txMessage[6] = pumpID[0];
      txMessage[7] = 0x83;
      txMessage[8] = 0x01;
      txMessage[9] = 0x03;
      for (i=10; i<74; i++) txMessage[i] = 0x00;
      write(fdMMCommander, txMessage, 73);
      printTime();
      printf (" TX : ");
      for (i=3; i< 73; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
      printf ("XX \n");
      fflush(stdout);
      sleep(0.5);
      resume_timer(500);
      break;
    case 0x0072:
      pause_timer();
      txMessage[0] = 0x81;
      txMessage[1] = 0x46;
      txMessage[2] = 0x01;
      txMessage[3] = 0xA7;
      txMessage[4] = pumpID[2];
      txMessage[5] = pumpID[1];
      txMessage[6] = pumpID[0];
      txMessage[7] = 0x72;
      txMessage[8] = 0x03;
      txMessage[9] = 0x00;
      txMessage[10] = 0x00;
      txMessage[11] = 0x7F;
      for (i=12; i<74; i++) txMessage[i] = 0x00;
      write(fdMMCommander, txMessage, 73);
      printTime();
      printf (" TX : ");
      for (i=3; i< 73; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
      printf ("XX \n");
      fflush(stdout);
      sleep(0.5);
      resume_timer(500);
      break;
    case 0x0073:
      pause_timer();
      txMessage[0] = 0x81;
      txMessage[1] = 0x46;
      txMessage[2] = 0x01;
      txMessage[3] = 0xA7;
      txMessage[4] = pumpID[2];
      txMessage[5] = pumpID[1];
      txMessage[6] = pumpID[0];
      txMessage[7] = 0x73;
      txMessage[8] = 0x04;
      txMessage[9] = 0x00;
      txMessage[10] = 0x00;
      txMessage[11] = 0x29;
      txMessage[12] = 0x2A;
      for (i=13; i<74; i++) txMessage[i] = 0x00;
      write(fdMMCommander, txMessage, 73);
      printTime();
      printf (" TX : ");
      for (i=3; i< 73; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
      printf ("XX \n");
      fflush(stdout);
      sleep(0.5);
      resume_timer(500);
      break;
    case 0x0076:
      pause_timer();
      txMessage[0] = 0x81;
      txMessage[1] = 0x46;
      txMessage[2] = 0x01;
      txMessage[3] = 0xA7;
      txMessage[4] = pumpID[2];
      txMessage[5] = pumpID[1];
      txMessage[6] = pumpID[0];
      txMessage[7] = 0x76;
      txMessage[8] = 0x12;
      for (i=9; i<27; i++) txMessage[i] = 0x2D;   
      for (i=27; i<74; i++) txMessage[i] = 0x00;
      write(fdMMCommander, txMessage, 73);
      printTime();
      printf (" TX : ");
      for (i=3; i< 73; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
      printf ("XX \n");
      fflush(stdout);
      sleep(0.5);
      resume_timer(500);
      break;
    case 0x0080:
      pause_timer();
      txMessage[0] = 0x81;
      txMessage[1] = 0x46;
      txMessage[2] = 0x01;
      txMessage[3] = 0xA7;
      txMessage[4] = pumpID[2];
      txMessage[5] = pumpID[1];
      txMessage[6] = pumpID[0];
      if (((message[5]&0x00FF) == 0x0000) &&
          (length == 7)){
	txMessage[1] = 0x06;
	txMessage[7] = 0x06;
	txMessage[8] = 0x00;	
	txLen = 9;
	historyEnable = 1;
      } else if ((historyEnable == 1) &&
                 (length == 71)) {
	historyReading = 1;
	historyLine = 0;
	historyPage   = (message[6]&0x00FF) ;
	txMessage[7] = 0x80;
	getHistoryLine(&txMessage[8]);
	txLen = 73;
      }
      for (i=txLen; i<74; i++) txMessage[i] = 0x00;
      sleep(0.5);
      write(fdMMCommander, txMessage, txLen);
      printTime();
      printf (" TX : ");
      for (i=3; i< txLen; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
      printf ("XX \n");
      fflush(stdout);
      resume_timer(5);
      break;      
    case 0x0095:
      pause_timer();
      txMessage[0] = 0x81;
      txMessage[1] = 0x46;
      txMessage[2] = 0x01;
      txMessage[3] = 0xA7;
      txMessage[4] = pumpID[2];
      txMessage[5] = pumpID[1];
      txMessage[6] = pumpID[0];
      txMessage[7] = 0x95;
      txMessage[8] = 0x12;
      if (glucometerActive == 1) {
	if ( ( (glucometerID[2]>>4) & 0x000F ) < 0x0A ) 
                 txMessage[9]  = ( (glucometerID[2]>>4) & 0x000F ) + 0x30;
	else     txMessage[9]  = ( (glucometerID[2]>>4) & 0x000F ) - 0x0A + 0x41;
	if ( ( (glucometerID[2]   ) & 0x000F ) < 0x0A ) 
                 txMessage[10] = ( (glucometerID[2]   ) & 0x000F ) + 0x30;
	else     txMessage[10] = ( (glucometerID[2]   ) & 0x000F ) - 0x0A + 0x41;
	if ( ( (glucometerID[1]>>4) & 0x000F ) < 0x0A ) 
                 txMessage[11] = ( (glucometerID[1]>>4) & 0x000F ) + 0x30;
	else     txMessage[11] = ( (glucometerID[1]>>4) & 0x000F ) - 0x0A + 0x41;
	if ( ( (glucometerID[1]   ) & 0x000F ) < 0x0A ) 
                 txMessage[12] = ( (glucometerID[1]   ) & 0x000F ) + 0x30;
	else     txMessage[12] = ( (glucometerID[1]   ) & 0x000F ) - 0x0A + 0x41;
	if ( ( (glucometerID[0]>>4) & 0x000F ) < 0x0A ) 
                 txMessage[13] = ( (glucometerID[0]>>4) & 0x000F ) + 0x30;
	else     txMessage[13] = ( (glucometerID[0]>>4) & 0x000F ) - 0x0A + 0x41;
	if ( ( (glucometerID[0]   ) & 0x000F ) < 0x0A ) 
                 txMessage[14] = ( (glucometerID[0]   ) & 0x000F ) + 0x30;
	else     txMessage[14] = ( (glucometerID[0]   ) & 0x000F ) - 0x0A + 0x41;
	for (i=15; i<27; i++) txMessage[i] = 0x2D;
      } else {
	for (i=9; i<27; i++) txMessage[i] = 0x2D;   
      }
      for (i=27; i<74; i++) txMessage[i] = 0x00;
      write(fdMMCommander, txMessage, 73);
      printTime();
      printf (" TX : ");
      for (i=3; i< 73; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
      printf ("XX \n");
      fflush(stdout);
      sleep(0.5);
      resume_timer(500);
      break;
    case 0x0098:  // Read temp basal
      pause_timer();
      txMessage[0] = 0x81;
      txMessage[1] = 0x46;
      txMessage[2] = 0x01;
      txMessage[3] = 0xA7;
      txMessage[4] = pumpID[2];
      txMessage[5] = pumpID[1];
      txMessage[6] = pumpID[0];
      txMessage[7] = 0x98;
      txMessage[8] = 0x06;
      txMessage[9] = 0x01;
      txMessage[10] = 0x32; // Rate - Percentage
      txMessage[11] = 0x00;
      txMessage[12] = 0x11; // ??????
      txMessage[13] = 0x00;
      txMessage[14] = 0x3C; // Duration - Minutes
      for (i=15; i<74; i++) txMessage[i] = 0x00;
      write(fdMMCommander, txMessage, 73);
      printTime();
      printf (" TX : ");
      for (i=3; i< 73; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
      printf ("XX \n");
      fflush(stdout);
      sleep(0.5);
      resume_timer(500);
      break;
    case 0x009A:
      pause_timer();
      txMessage[0] = 0x81;
      txMessage[1] = 0x46;
      txMessage[2] = 0x01;
      txMessage[3] = 0xA7;
      txMessage[4] = pumpID[2];
      txMessage[5] = pumpID[1];
      txMessage[6] = pumpID[0];
      if (((message[5]&0x00FF) == 0x0000) &&
          (length == 7)){
	txMessage[1] = 0x06;
	txMessage[7] = 0x06;
	txMessage[8] = 0x00;	
	txLen = 9;
	cgmHistoryEnable = 1;
      } else if ((cgmHistoryEnable == 1) &&
                 (length == 71)) {
	cgmHistoryReading = 1;
	cgmHistoryLine = 0;
	cgmHistoryPage   = ((message[9]&0x00FF)      );
	cgmHistoryPage  += ((message[8]&0x00FF) <<  8);
	cgmHistoryPage  += ((message[7]&0x00FF) << 16);
	cgmHistoryPage  += ((message[6]&0x00FF) << 24);
	txMessage[7] = 0x9A;
	getCGMHistoryLine(&txMessage[8]);
	txLen = 73;
      }
      for (i=txLen; i<74; i++) txMessage[i] = 0x00;
      sleep(0.5);
      write(fdMMCommander, txMessage, txLen);
      printTime();
      printf (" TX : ");
      for (i=3; i< txLen; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
      printf ("XX \n");
      fflush(stdout);
      resume_timer(5);
      break;      
    case 0x009C:
      pause_timer();
      txMessage[0] = 0x81;
      txMessage[1] = 0x46;
      txMessage[2] = 0x01;
      txMessage[3] = 0xA7;
      txMessage[4] = pumpID[2];
      txMessage[5] = pumpID[1];
      txMessage[6] = pumpID[0];
      txMessage[7] = 0x9C;
      txMessage[8] = 0x02;
      txMessage[9] = 0x25;
      txMessage[10] = 0x57;
      for (i=11; i<74; i++) txMessage[i] = 0x00;
      write(fdMMCommander, txMessage, 73);
      printTime();
      printf (" TX : ");
      for (i=3; i< 73; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
      printf ("XX \n");
      fflush(stdout);
      sleep(0.5);
      resume_timer(500);
      break;
    case 0x009D:
      pause_timer();
      txMessage[0] = 0x81;
      txMessage[1] = 0x46;
      txMessage[2] = 0x01;
      txMessage[3] = 0xA7;
      txMessage[4] = pumpID[2];
      txMessage[5] = pumpID[1];
      txMessage[6] = pumpID[0];
      txMessage[7] = 0x9D;
      txMessage[8] = 0x04;
      txMessage[9] = 0x00;
      txMessage[10] = 0x00;
      txMessage[11] = 0x00;
      txMessage[12] = 0x02;
      for (i=13; i<74; i++) txMessage[i] = 0x00;
      write(fdMMCommander, txMessage, 73);
      printTime();
      printf (" TX : ");
      for (i=3; i< 73; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
      printf ("XX \n");
      fflush(stdout);
      sleep(0.5);
      resume_timer(500);
      break;
    case 0x00CD:
      //      pause_timer();
      txMessage[0] = 0x81;
      txMessage[1] = 0x46;
      txMessage[2] = 0x01;
      txMessage[3] = 0xA7;
      txMessage[4] = pumpID[2];
      txMessage[5] = pumpID[1];
      txMessage[6] = pumpID[0];
      txMessage[7] = 0xCD;
      txMessage[8] = 0x0C;
      txMessage[9] = 0x00;
      txMessage[10] = 0x00;
      txMessage[11] = 0x00; 
      txMessage[12] = 0x3A; 
      txMessage[13] = 0x00; 
      txMessage[14] = 0x20; 
      txMessage[15] = 0x00; 
      txMessage[16] = 0x20; 
      txMessage[17] = 0x00; 
      txMessage[18] = 0x20; 
      txMessage[19] = 0x00; 
      txMessage[20] = 0x20; 
      for (i=21; i<74; i++) txMessage[i] = 0x00;
      write(fdMMCommander, txMessage, 73);
      printTime();
      printf (" TX : ");
      for (i=3; i< 73; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
      printf ("XX \n");
      fflush(stdout);
      sleep(0.5);
      //      resume_timer(500);
      break;
    case 0x00CF:
      pause_timer();
      txMessage[0]  = 0x81;
      txMessage[1]  = 0x46;
      txMessage[2]  = 0x01;
      txMessage[3]  = 0xA7;
      txMessage[4]  = pumpID[2];
      txMessage[5]  = pumpID[1];
      txMessage[6]  = pumpID[0];
      txMessage[7]  = 0xCF;
      txMessage[8]  = 0x40;
      txMessage[9]  = 0x80;
      txMessage[10] = 0x03;
      txMessage[11] = 0x01;
      txMessage[12] = 0x00;
      txMessage[13] = 0x80;
      txMessage[14] = 0xC8;
      txMessage[15] = 0x80;
      txMessage[16] = 0x46;
      txMessage[17] = 0x00;
      txMessage[18] = 0x03;
      txMessage[19] = 0xFF;
      txMessage[20] = 0x03;
      txMessage[21] = 0xFF;
      txMessage[22] = 0x00;
      txMessage[23] = 0x03;
      txMessage[24] = 0xFF;
      txMessage[25] = 0x03;
      txMessage[26] = 0xFF;
      txMessage[27] = 0x00;
      txMessage[28] = 0x03;
      txMessage[29] = 0xFF;
      txMessage[30] = 0x03;
      txMessage[31] = 0xFF;
      txMessage[32] = 0x00;
      txMessage[33] = 0x03;
      txMessage[34] = 0xFF;
      txMessage[35] = 0x03;
      txMessage[36] = 0xFF;
      txMessage[37] = 0x00;
      txMessage[38] = 0x03;
      txMessage[39] = 0xFF;
      txMessage[40] = 0x03;
      txMessage[41] = 0xFF;
      txMessage[42] = 0x00;
      txMessage[43] = 0x03;
      txMessage[44] = 0xFF;
      txMessage[45] = 0x03;
      txMessage[46] = 0xFF;
      txMessage[47] = 0x00;
      txMessage[48] = 0x03;
      txMessage[49] = 0xFF;
      txMessage[50] = 0x03;
      txMessage[51] = 0xFF;
      txMessage[52] = 0x00;
      txMessage[53] = 0x3C;
      txMessage[54] = 0x00;
      txMessage[55] = 0x14;
      txMessage[56] = 0x00;
      txMessage[57] = 0x1E;
      txMessage[58] = 0x00;
      txMessage[59] = 0xB4;
      txMessage[60] = 0x00;
      txMessage[61] = 0x46;
      txMessage[62] = 0x01;
      txMessage[63] = 0x00;
      txMessage[64] = 0x3C;
      txMessage[65] = enliteID[2];
      txMessage[66] = enliteID[1];
      txMessage[67] = enliteID[0];
      txMessage[68] = 0x01;
      txMessage[69] = 0x00;
      txMessage[70] = 0x1E;
      txMessage[71] = 0x00;
      txMessage[72] = 0x37;
      write(fdMMCommander, txMessage, 73);
      printTime();
      printf (" TX : ");
      for (i=3; i< 73; i++) printf("%.2X ", (txMessage[i] & 0x00FF));
      printf ("XX \n");
      fflush(stdout);
      sleep(0.5);
      resume_timer(500);
      break;
    default:
      break;
    }

    lastCommand = message[4];
  }
}

void sendPumpACK (void)
{
  float realTime;
  float realPeriod;
  int   dataMsec;

  stop_timer();

  txMessage[0] = 0x81;
  txMessage[1] = 0x06;
  txMessage[2] = 0x01;
  txMessage[3] = 0xA7;
  txMessage[4] = pumpID[2];
  txMessage[5] = pumpID[1];
  txMessage[6] = pumpID[0];
  txMessage[7] = 0x06;
  txMessage[8] = 0x00;
  write(fdMMCommander, txMessage, 9);
  printTime();
  printf (" TX : A7 %.2X %.2X %.2X 06 00 XX \n", pumpID[2], pumpID[1], pumpID[0]);
  fflush(stdout);

  if ((enliteActive == 1) && (enliteManualMode == 0)) {
    start_timer((int)(round(time2enlite*1000.0)), &enliteTx);
  }

}

void printTime (void)
{
  struct timeval tv;
  struct timezone tz;
  struct tm *tm;

  gettimeofday(&tv, &tz);
  tm=localtime(&tv.tv_sec);
  printf (" %02d:%02d:%02d:%03ld -",tm->tm_hour, tm->tm_min, tm->tm_sec, (tv.tv_usec/1000) );
}

int start_timer(int mSec, void (*timer_func_handler)(void))
{

  timer_func_handler_pntr = timer_func_handler;
 
  timervalue.it_interval.tv_sec = mSec / 1000;
  timervalue.it_interval.tv_usec = (mSec % 1000) * 1000;
  timervalue.it_value.tv_sec = mSec / 1000;
  timervalue.it_value.tv_usec = (mSec % 1000) * 1000;
  if(setitimer(ITIMER_REAL, &timervalue, NULL))
  {
    printf("\nsetitimer() error\n");
    return(1);
  }
 
  new_handler.sa_handler = &timer_sig_handler;
  new_handler.sa_flags = SA_NOMASK;
  if(sigaction(SIGALRM, &new_handler, &old_handler))
  {
    printf("\nsigaction() error\n");
    return(1);
  }
  timerActive = 1;
  return(0);
}

void timer_sig_handler(int arg)
{
  timer_func_handler_pntr();
}

void pause_timer (void)
{
  struct itimerval timerinfo;
  
  if (timerActive == 1) {
    getitimer(ITIMER_REAL,&timerinfo);
    timerTimeLeft  = (float)(timerinfo.it_value.tv_sec) + ((float)(timerinfo.it_value.tv_usec)/1000000.0);
    timerinfo.it_interval.tv_sec = 0;
    timerinfo.it_interval.tv_usec = 0;
    timerinfo.it_value.tv_sec = 0;
    timerinfo.it_value.tv_usec = 0;
    setitimer(ITIMER_REAL, &timervalue, NULL);
  }
}

void resume_timer (int timesub)
{
  struct itimerval timerinfo;

  float realTime;
  int   realMsec;

  if (timerActive == 1) {
    realMsec = (int)(timerTimeLeft*1000) - timesub;
    if (realMsec < 0) realMsec = 100;
    timerinfo.it_interval = timervalue.it_interval;
    timerinfo.it_value.tv_sec = realMsec / 1000;
    timerinfo.it_value.tv_usec = (realMsec % 1000) * 1000;
    setitimer(ITIMER_REAL, &timerinfo, NULL);
  }
}

void stop_timer(void)
{
  timervalue.it_interval.tv_sec = 0;
  timervalue.it_interval.tv_usec = 0;
  timervalue.it_value.tv_sec = 0;
  timervalue.it_value.tv_usec = 0;
  setitimer(ITIMER_REAL, &timervalue, NULL);

  sigaction(SIGALRM, &old_handler, NULL);
  timerActive = 0;
}

int kbhit(void)
{
  struct termios oldt, newt;
  int ch;
  int oldf;
 
  tcgetattr(STDIN_FILENO, &oldt);
  newt = oldt;
  newt.c_lflag &= ~(ICANON | ECHO);
  tcsetattr(STDIN_FILENO, TCSANOW, &newt);
  oldf = fcntl(STDIN_FILENO, F_GETFL, 0);
  fcntl(STDIN_FILENO, F_SETFL, oldf | O_NONBLOCK);
 
  ch = getchar();
 
  tcsetattr(STDIN_FILENO, TCSANOW, &oldt);
  fcntl(STDIN_FILENO, F_SETFL, oldf);
 
  if(ch != EOF)
  {
    ungetc(ch, stdin);
    return 1;
  }
 
  return 0;
}

void getCGMHistoryLine (char *line)
{
  char histPages[2][16*64] = {
    { 0x4C, 0x4C, 0x4C, 0x4B, 0x4B, 0x4C, 0x4C, 0x4C, 0x4D, 0x4D, 0x4E, 0x4D, 0x4D, 0x4D, 0x4F, 0x4F, 
      0x50, 0x50, 0x50, 0x51, 0x4F, 0x4F, 0x50, 0x50, 0x50, 0x4F, 0x4F, 0x4E, 0x4E, 0x4E, 0x4E, 0x4E, 
      0x4D, 0x4D, 0x4D, 0x4B, 0x49, 0x49, 0x49, 0x49, 0x13, 0x49, 0x49, 0x4A, 0x4B, 0x9B, 0x8E, 0x04, 
      0xD9, 0x88, 0x0E, 0x00, 0x00, 0x01, 0x0E, 0x04, 0xD9, 0x88, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x04,
      0xDB, 0x88, 0x10, 0x4B, 0x4A, 0x4B, 0x18, 0x16, 0x0E, 0x04, 0xE6, 0x88, 0x0F, 0x4B, 0x4A, 0x48, 
      0x48, 0x47, 0x48, 0x44, 0x3E, 0x3B, 0x42, 0x47, 0x49, 0x47, 0x47, 0x49, 0x4E, 0x52, 0x4E, 0x43, 
      0x3E, 0x3E, 0x41, 0x42, 0x43, 0x13, 0x43, 0x44, 0x44, 0x41, 0x43, 0x44, 0x42, 0x3F, 0x3C, 0x3D, 
      0x3F, 0x3F, 0x3E, 0x3E, 0x40, 0x43, 0x43, 0x3F, 0x3E, 0x3E, 0x41, 0x43, 0x43, 0x13, 0x41, 0x42,
      0x43, 0x44, 0x93, 0x8E, 0x04, 0xF5, 0x8C, 0x0E, 0x45, 0x47, 0x49, 0x2D, 0x16, 0x0E, 0x04, 0xC8, 
      0x8D, 0x0F, 0x49, 0x00, 0x00, 0x01, 0x0E, 0x04, 0xCF, 0x8D, 0x10, 0x46, 0x44, 0x43, 0x44, 0x46, 
      0x47, 0x45, 0x45, 0x45, 0x47, 0x4A, 0x49, 0x49, 0x4A, 0x4D, 0x54, 0x5B, 0x00, 0x00, 0x01, 0x0E, 
      0x04, 0xE7, 0x8E, 0x10, 0x13, 0x02, 0x13, 0x02, 0x13, 0x02, 0x13, 0x02, 0x13, 0x02, 0x13, 0x02,
      0x0E, 0x44, 0xC7, 0x8F, 0x08, 0x13, 0x02, 0x13, 0x02, 0x0E, 0x44, 0xD1, 0x8F, 0x08, 0x0E, 0x44, 
      0xD8, 0x8F, 0x0B, 0x0E, 0x44, 0xD1, 0x8F, 0x08, 0x0E, 0x64, 0xD8, 0x8F, 0x0D, 0x0E, 0x44, 0xE5, 
      0x8F, 0x0B, 0x00, 0x00, 0x01, 0x0E, 0x04, 0xE0, 0x92, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x04, 0xE4, 
      0x92, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x04, 0xD0, 0x94, 0x10, 0x0E, 0x44, 0xD1, 0x8F, 0x08, 0x0E,
      0x64, 0xEB, 0x94, 0x0D, 0x0E, 0x44, 0xF8, 0x94, 0x0B, 0x00, 0x00, 0x01, 0x0E, 0x04, 0xCA, 0x95, 
      0x10, 0x00, 0x00, 0x01, 0x0E, 0x04, 0xD5, 0x95, 0x10, 0x0E, 0x04, 0xD7, 0x95, 0x0B, 0x0E, 0x24, 
      0xED, 0x95, 0x0B, 0x0E, 0x24, 0xF0, 0x95, 0x0D, 0x00, 0x03, 0x13, 0x02, 0x0E, 0x44, 0xF5, 0x95, 
      0x08, 0x0E, 0x04, 0xF6, 0x95, 0x0B, 0x00, 0x00, 0x01, 0x0E, 0x04, 0xDE, 0x97, 0x10, 0x00, 0x00,
      0x01, 0x0E, 0x04, 0xDF, 0x97, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x05, 0xD2, 0x88, 0x10, 0x00, 0x00, 
      0x01, 0x0E, 0x05, 0xD3, 0x88, 0x10, 0x0E, 0x04, 0xF5, 0x95, 0x08, 0x00, 0x00, 0x01, 0x0E, 0x05, 
      0xD3, 0x8D, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x05, 0xD8, 0x8D, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x05, 
      0xEC, 0x90, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x05, 0xE1, 0x95, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x05,
      0xDD, 0x96, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x06, 0xDD, 0x88, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x06, 
      0xDF, 0x88, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x06, 0xDB, 0x8D, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x06, 
      0xEF, 0x8D, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x06, 0xC9, 0x96, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x07, 
      0xDA, 0x88, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x07, 0xDC, 0x88, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x07,
      0xEE, 0x8B, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x07, 0xEF, 0x8B, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x07, 
      0xC9, 0x8F, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x07, 0xCB, 0x8F, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x07, 
      0xCB, 0x92, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x07, 0xE1, 0x95, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x07, 
      0xE2, 0x95, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x08, 0xD1, 0x88, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x08,
      0xD2, 0x88, 0x10, 0x0E, 0x04, 0xF5, 0x95, 0x08, 0x00, 0x00, 0x01, 0x0E, 0x08, 0xCD, 0x8A, 0x10, 
      0x00, 0x00, 0x01, 0x0E, 0x08, 0xC0, 0x8F, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x08, 0xC7, 0x8F, 0x10, 
      0x00, 0x00, 0x01, 0x0E, 0x08, 0xF0, 0x95, 0x10, 0x0E, 0x44, 0xF5, 0x95, 0x08, 0x0E, 0x09, 0xE2, 
      0x80, 0x0A, 0x0E, 0x29, 0xE2, 0x80, 0x0A, 0x0E, 0x09, 0xE2, 0x80, 0x0B, 0x00, 0x00, 0x01, 0x0E,
      0x09, 0xCB, 0x81, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x09, 0xCC, 0x81, 0x10, 0x00, 0x00, 0x01, 0x0E, 
      0x09, 0xD7, 0x88, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x09, 0xD9, 0x88, 0x10, 0x00, 0x00, 0x01, 0x0E, 
      0x09, 0xD7, 0x8A, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x09, 0xC0, 0x8F, 0x10, 0x00, 0x00, 0x01, 0x0E, 
      0x09, 0xC9, 0x8F, 0x10, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x59, 0x11 } ,

    { 0x00, 0x00, 0x01, 0x0E, 0x01, 0xF0, 0x95, 0x10, 0x37, 0x36, 0x34, 0x31, 0x31, 0x32, 0x3C, 0x4C, 
      0x48, 0x4D, 0x00, 0x00, 0x01, 0x0E, 0x01, 0xE3, 0x96, 0x10, 0x50, 0x54, 0x57, 0x56, 0x55, 0x55, 
      0x56, 0x58, 0x59, 0x57, 0x53, 0x50, 0x4D, 0x49, 0x43, 0x3D, 0x36, 0x30, 0x13, 0x2C, 0x29, 0x27, 
      0x24, 0x23, 0x23, 0x24, 0x24, 0x24, 0x23, 0x22, 0x21, 0x1E, 0x1B, 0x13, 0x1A, 0x19, 0x18, 0x18, 
      0x17, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16, 0x17, 0x16, 0x16, 0x16, 0x17, 0x17, 
      0x17, 0x18, 0x1A, 0x1B, 0x1C, 0x1D, 0x1E, 0x20, 0x24, 0x22, 0x1F, 0x1E, 0x21, 0x25, 0x27, 0x29, 
      0x2B, 0x2D, 0x32, 0x35, 0x36, 0x39, 0x3A, 0x39, 0x36, 0x34, 0x34, 0x34, 0x34, 0x3D, 0x47, 0x4B, 
      0x4C, 0x4C, 0x4A, 0x49, 0x49, 0x49, 0x49, 0x49, 0x49, 0x49, 0x48, 0x48, 0x48, 0x47, 0x46, 0x00, 
      0x03, 0x00, 0x03, 0x00, 0x03, 0x00, 0x03, 0x00, 0x03, 0x00, 0x03, 0x00, 0x03, 0x00, 0x03, 0x00, 
      0x03, 0x00, 0x03, 0x00, 0x03, 0x00, 0x03, 0x00, 0x03, 0x00, 0x03, 0x00, 0x03, 0xE3, 0x8E, 0x02, 
      0xC7, 0x88, 0x0E, 0x00, 0x00, 0x01, 0x0E, 0x02, 0xC7, 0x88, 0x10, 0x01, 0x03, 0x00, 0x00, 0x01, 
      0x0E, 0x02, 0xC8, 0x88, 0x10, 0x01, 0x03, 0x58, 0x24, 0x28, 0x0E, 0x02, 0xD2, 0x88, 0x0F, 0x5A, 
      0x13, 0x5A, 0x5B, 0x5B, 0x59, 0x59, 0x58, 0x56, 0x55, 0x13, 0x55, 0x70, 0xB2, 0x8E, 0x02, 0xD1, 
      0x89, 0x0E, 0x85, 0x79, 0x64, 0xD0, 0x20, 0x0E, 0x02, 0xDC, 0x89, 0x0F, 0x63, 0x62, 0x60, 0x5F, 
      0x5E, 0x5D, 0x5B, 0x5C, 0x5D, 0x5C, 0x5C, 0x5B, 0x5B, 0x5B, 0x5C, 0x5E, 0x5E, 0x9D, 0x8E, 0x02, 
      0xF9, 0x8A, 0x0E, 0x00, 0x00, 0x01, 0x0E, 0x02, 0xF9, 0x8A, 0x10, 0x5E, 0x5C, 0x56, 0xCF, 0x1E, 
      0x0E, 0x02, 0xC8, 0x8B, 0x0F, 0x55, 0x53, 0x50, 0x4E, 0x4D, 0x4C, 0x4B, 0x49, 0x46, 0x43, 0x40, 
      0x3E, 0x3D, 0x3D, 0x3E, 0x3F, 0x41, 0x43, 0x00, 0x00, 0x01, 0x0E, 0x02, 0xEB, 0x8C, 0x10, 0x45, 
      0x47, 0x48, 0x49, 0x49, 0x4A, 0x4B, 0x4D, 0x52, 0x53, 0x52, 0x00, 0x00, 0x01, 0x0E, 0x02, 0xE3, 
      0x8D, 0x10, 0x50, 0x4F, 0x4E, 0x4F, 0x52, 0x58, 0x5D, 0x00, 0x00, 0x01, 0x0E, 0x02, 0xCB, 0x8E, 
      0x10, 0x60, 0x62, 0x64, 0x64, 0x63, 0x00, 0x00, 0x01, 0x0E, 0x02, 0xE3, 0x8E, 0x10, 0x61, 0x5E, 
      0x5A, 0x56, 0x52, 0x4F, 0x4E, 0x00, 0x00, 0x01, 0x0E, 0x02, 0xCE, 0x8F, 0x10, 0x4C, 0x4C, 0x4D, 
      0x4D, 0x4C, 0x4C, 0x4C, 0x4D, 0x4E, 0x4E, 0x4D, 0x4A, 0x00, 0x00, 0x01, 0x0E, 0x02, 0xCC, 0x90, 
      0x10, 0x45, 0x42, 0x40, 0x3E, 0x3C, 0x39, 0x36, 0x33, 0x30, 0x2D, 0x2B, 0x2A, 0x2A, 0x2A, 0x29, 
      0x28, 0x28, 0x29, 0x2B, 0x2D, 0x2F, 0x32, 0x34, 0x35, 0x36, 0x37, 0x38, 0x38, 0x38, 0x38, 0x38, 
      0x39, 0x35, 0x37, 0x39, 0x3B, 0x39, 0x35, 0x32, 0x30, 0x30, 0x31, 0x33, 0x39, 0x3E, 0x41, 0x42, 
      0x42, 0x45, 0x44, 0x45, 0x46, 0x47, 0x47, 0x46, 0x48, 0x4A, 0x4C, 0x4F, 0x50, 0x51, 0x56, 0x5B, 
      0x8F, 0x8E, 0x02, 0xDA, 0x95, 0x0E, 0x00, 0x00, 0x01, 0x0E, 0x02, 0xDA, 0x95, 0x10, 0x5E, 0x60, 
      0x64, 0x99, 0x8E, 0x02, 0xEA, 0x95, 0x0E, 0x66, 0x68, 0x55, 0xA1, 0x18, 0x0E, 0x02, 0xF6, 0x95, 
      0x0F, 0x57, 0x58, 0x58, 0x59, 0x58, 0x00, 0x00, 0x01, 0x0E, 0x02, 0xD3, 0x96, 0x10, 0x58, 0x57, 
      0x55, 0x53, 0x51, 0x52, 0x54, 0x57, 0x5B, 0x5F, 0x62, 0x64, 0x65, 0x64, 0x63, 0x63, 0x62, 0x61, 
      0x60, 0x60, 0xA3, 0x8E, 0x02, 0xFA, 0x97, 0x0E, 0x5F, 0x5F, 0x56, 0x54, 0x16, 0x0E, 0x03, 0xCD, 
      0x80, 0x0F, 0x56, 0x56, 0x56, 0x56, 0x55, 0x54, 0x54, 0x54, 0x53, 0x53, 0x52, 0x52, 0x51, 0x50, 
      0x50, 0x4F, 0x4F, 0x4E, 0x4E, 0x4D, 0x4D, 0x4D, 0x4E, 0x4E, 0x4E, 0x4F, 0x4F, 0x4E, 0x4D, 0x4C, 
      0x4C, 0x4B, 0x4A, 0x4A, 0x49, 0x48, 0x48, 0x47, 0x47, 0x47, 0x47, 0x47, 0x48, 0x47, 0x47, 0x47, 
      0x47, 0x47, 0x46, 0x47, 0x46, 0x47, 0x47, 0x47, 0x47, 0x48, 0x48, 0x48, 0x49, 0x4A, 0x4A, 0x4A, 
      0x49, 0x49, 0x49, 0x48, 0x48, 0x47, 0x47, 0x47, 0x47, 0x46, 0x46, 0x46, 0x46, 0x45, 0x46, 0x47, 
      0x47, 0x47, 0x47, 0x46, 0x46, 0x45, 0x45, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x45, 0x46, 0x48, 
      0x4A, 0x4C, 0x9B, 0x8E, 0x03, 0xCE, 0x88, 0x0E, 0x50, 0x00, 0x00, 0x01, 0x0E, 0x03, 0xD2, 0x88, 
      0x10, 0x00, 0x00, 0x01, 0x0E, 0x03, 0xD4, 0x88, 0x10, 0x54, 0x57, 0x4F, 0xE1, 0x13, 0x0E, 0x03, 
      0xE2, 0x88, 0x0F, 0x50, 0x4E, 0x4D, 0x4C, 0x4B, 0x4B, 0x4A, 0x4B, 0x50, 0x54, 0x56, 0x56, 0x54, 
      0x53, 0x53, 0x53, 0x52, 0x51, 0x4F, 0x4E, 0x4D, 0x4C, 0x49, 0x47, 0x47, 0x46, 0x45, 0x43, 0x41, 
      0x3E, 0x3F, 0x3E, 0x40, 0x40, 0x3E, 0x3C, 0x3C, 0x3C, 0x3D, 0x3A, 0x38, 0x38, 0x39, 0x38, 0x37, 
      0x35, 0x35, 0x35, 0x36, 0x36, 0x35, 0x38, 0x38, 0x39, 0x13, 0x38, 0x13, 0x37, 0x35, 0x38, 0x37, 
      0x36, 0x38, 0x13, 0x37, 0x00, 0x00, 0x01, 0x0E, 0x03, 0xEE, 0x8D, 0x10, 0x36, 0x31, 0x33, 0x00, 
      0x00, 0x01, 0x0E, 0x03, 0xFB, 0x8D, 0x10, 0x30, 0x2B, 0x13, 0x2F, 0x32, 0x33, 0x34, 0x38, 0x3C, 
      0x00, 0x00, 0x01, 0x0E, 0x03, 0xE9, 0x8E, 0x10, 0x13, 0x3E, 0x13, 0x45, 0x4D, 0x50, 0x4E, 0x4F, 
      0x4E, 0x4E, 0x4B, 0x13, 0x4A, 0x4A, 0x48, 0x13, 0x47, 0x48, 0x48, 0x4B, 0x4C, 0x4B, 0x47, 0x48, 
      0x48, 0x4D, 0x00, 0x00, 0x01, 0x0E, 0x03, 0xE1, 0x90, 0x10, 0x4C, 0x4B, 0x4A, 0x01, 0x05, 0x0E, 
      0x43, 0xEF, 0x90, 0x08, 0x0E, 0x43, 0xF0, 0x90, 0x0B, 0x0E, 0x23, 0xF1, 0x90, 0x0D, 0x00, 0x03, 
      0xA9, 0x8E, 0x03, 0xF5, 0x90, 0x0E, 0x01, 0x03, 0x01, 0x03, 0x54, 0x21, 0x16, 0x0E, 0x03, 0xC8, 
      0x91, 0x0F, 0x58, 0x58, 0x00, 0x00, 0x01, 0x0E, 0x03, 0xD4, 0x91, 0x10, 0x55, 0x52, 0x56, 0x5A, 
      0x5A, 0x5C, 0x5B, 0x5A, 0x5A, 0x13, 0x57, 0x55, 0x55, 0x5A, 0x58, 0x54, 0x55, 0x56, 0x57, 0x5A, 
      0x00, 0x00, 0x01, 0x0E, 0x03, 0xF5, 0x92, 0x10, 0x5A, 0x59, 0x5A, 0x5A, 0x5E, 0x62, 0x63, 0x62, 
      0x5F, 0x5A, 0x54, 0x54, 0x54, 0x56, 0x57, 0x55, 0x54, 0x52, 0x53, 0x5B, 0x5D, 0x59, 0x5A, 0x5A, 
      0x59, 0x58, 0x58, 0x58, 0x56, 0x8D, 0x8E, 0x03, 0xD5, 0x95, 0x0E, 0x00, 0x00, 0x01, 0x0E, 0x03, 
      0xD5, 0x95, 0x10, 0x00, 0x00, 0x01, 0x0E, 0x03, 0xD6, 0x95, 0x10, 0x53, 0x4E, 0x00, 0x00, 0x01, 
      0x0E, 0x03, 0xDD, 0x95, 0x10, 0x4B, 0x45, 0x30, 0x15, 0x0E, 0x03, 0xE6, 0x95, 0x0F, 0x42, 0x13, 
      0x41, 0x40, 0x3D, 0x39, 0x3A, 0x13, 0x3C, 0x3C, 0x3B, 0x39, 0x13, 0x38, 0x13, 0x37, 0x37, 0x37, 
      0x37, 0x36, 0x36, 0x36, 0x36, 0x35, 0x35, 0x34, 0x37, 0x38, 0x3A, 0x3D, 0x3F, 0x41, 0x13, 0x43, 
      0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x45, 0x45, 0x45, 0x45, 0x45, 0x13, 0x46, 0x46, 0x46, 0x46, 
      0x46, 0x47, 0x47, 0x47, 0x47, 0x48, 0x48, 0x48, 0x48, 0x48, 0x47, 0x46, 0x46, 0x46, 0x47, 0x47, 
      0x47, 0x48, 0x49, 0x4A, 0x4A, 0x4A, 0x4A, 0x4A, 0x4A, 0x49, 0x49, 0x49, 0x49, 0x4A, 0x4A, 0x4A, 
      0x4B, 0x4B, 0x4B, 0x4C, 0x4C, 0x4C, 0x4C, 0x4D, 0x4C, 0x0E, 0x24, 0xEA, 0x84, 0x08, 0x2B, 0x08 }
 };

  if (cgmHistoryLine == 0x0F) line[0] = 0x90;
  else line[0] = cgmHistoryLine + 1;

  if (cgmHistoryPage == 0x003A) memcpy(&line[1],&histPages[0][64*cgmHistoryLine],64);
  else memcpy(&line[1],&histPages[1][64*cgmHistoryLine],64);

  cgmHistoryLine++;
  
}

void getHistoryLine (char *line)
{

char histPages[2][16*64] = {
    { 0x5B, 0x00, 0xEA, 0x38, 0x0D, 0x7D, 0x0E, 0x14, 0x60, 0x04, 0x4C, 0x1E, 0x5A, 0x00, 0x00, 0x58,
      0x00, 0x00, 0x00, 0x00, 0x58, 0x64, 0x5C, 0x0E, 0xCC, 0x8E, 0x04, 0x2C, 0x98, 0x04, 0x2C, 0xA2,
      0x04, 0x68, 0xAC, 0x04, 0x69, 0x0C, 0xEA, 0x38, 0x0D, 0x1D, 0x0E, 0x10, 0x00, 0x01, 0x00, 0x58,
      0x00, 0x58, 0x00, 0x74, 0x00, 0xEA, 0x38, 0x4D, 0x7D, 0x0E, 0x5B, 0x00, 0xD0, 0x0A, 0x0E, 0x7D,
      0x0E, 0x50, 0x60, 0x04, 0x4C, 0x1E, 0x5A, 0x00, 0x01, 0x60, 0x00, 0x00, 0x00, 0x01, 0x60, 0x64,
      0x5C, 0x11, 0x58, 0x10, 0x04, 0xCC, 0x9C, 0x04, 0x2C, 0xA6, 0x04, 0x2C, 0xB0, 0x04, 0x68, 0xBA,
      0x04, 0x01, 0x01, 0x60, 0x01, 0x60, 0x00, 0xB0, 0x01, 0xD0, 0x0A, 0x6E, 0x7D, 0x0E, 0x0A, 0xB6,
      0xFA, 0x04, 0x31, 0x7D, 0x0E, 0x3F, 0x16, 0xFA, 0x04, 0xD1, 0x7D, 0x0E, 0xC0, 0x0C, 0x0F, 0x5B,
      0xB6, 0xD0, 0x07, 0x11, 0x7D, 0x0E, 0x00, 0x60, 0x04, 0x4C, 0x23, 0x5A, 0x5C, 0x00, 0x00, 0x00,
      0x00, 0x5C, 0x00, 0x00, 0x64, 0x5C, 0x1D, 0x4A, 0x99, 0x04, 0x74, 0xA3, 0x04, 0x76, 0xAD, 0x04,
      0x2C, 0xB7, 0x04, 0x58, 0xC1, 0x04, 0xCC, 0x4D, 0x14, 0x2C, 0x57, 0x14, 0x2C, 0x61, 0x14, 0x68,
      0x6B, 0x14, 0x01, 0x00, 0x38, 0x00, 0x38, 0x00, 0x5C, 0x00, 0xD1, 0x07, 0x51, 0x7D, 0x0E, 0x7B,
      0x05, 0xC0, 0x1E, 0x11, 0x1D, 0x0E, 0x23, 0x38, 0x00, 0x7B, 0x06, 0xC0, 0x1E, 0x14, 0x1D, 0x0E,
      0x29, 0x28, 0x00, 0x5B, 0x00, 0xF4, 0x2B, 0x14, 0x7D, 0x0E, 0x14, 0x60, 0x04, 0xB0, 0x2B, 0x5A,
      0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x60, 0x64, 0x5C, 0x14, 0x38, 0xDB, 0x04, 0x4A, 0x71,
      0x14, 0x74, 0x7B, 0x14, 0x76, 0x85, 0x14, 0x2C, 0x8F, 0x14, 0x58, 0x99, 0x14, 0x01, 0x00, 0x60,
      0x00, 0x60, 0x00, 0x08, 0x00, 0xF4, 0x2B, 0x54, 0x7D, 0x0E, 0x5B, 0x00, 0xE5, 0x09, 0x15, 0x7D,
      0x0E, 0x14, 0x60, 0x04, 0xB0, 0x2B, 0x5A, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x60, 0x64,
      0x5C, 0x1A, 0x58, 0x19, 0x04, 0x08, 0x23, 0x04, 0x38, 0xF5, 0x04, 0x4A, 0x8B, 0x14, 0x74, 0x95,
      0x14, 0x76, 0x9F, 0x14, 0x2C, 0xA9, 0x14, 0x58, 0xB3, 0x14, 0x69, 0x15, 0xE5, 0x09, 0x15, 0x1D,
      0x0E, 0x00, 0x00, 0x01, 0x00, 0x60, 0x00, 0x60, 0x00, 0x5C, 0x00, 0xE5, 0x09, 0x55, 0x7D, 0x0E,
      0x7B, 0x07, 0xC0, 0x1E, 0x15, 0x1D, 0x0E, 0x2B, 0x1C, 0x00, 0x5B, 0x00, 0xF4, 0x25, 0x15, 0x7D,
      0x0E, 0x50, 0x60, 0x04, 0xB0, 0x2B, 0x5A, 0x00, 0x01, 0x80, 0x00, 0x00, 0x00, 0x01, 0x80, 0x64,
      0x5C, 0x1D, 0x60, 0x21, 0x04, 0x58, 0x35, 0x04, 0x08, 0x3F, 0x04, 0x38, 0x11, 0x14, 0x4A, 0xA7,
      0x14, 0x74, 0xB1, 0x14, 0x76, 0xBB, 0x14, 0x2C, 0xC5, 0x14, 0x58, 0xCF, 0x14, 0x01, 0x01, 0x80,
      0x01, 0x80, 0x00, 0xAC, 0x02, 0xF4, 0x25, 0x75, 0x7D, 0x0E, 0x7B, 0x00, 0xC0, 0x00, 0x00, 0x1E,
      0x0E, 0x00, 0x4C, 0x00, 0x07, 0x00, 0x00, 0x0A, 0x1B, 0xDD, 0x0E, 0x00, 0x00, 0x00, 0x6E, 0xDD,
      0x0E, 0x09, 0x00, 0xAD, 0x7D, 0xD3, 0x03, 0x00, 0x00, 0x0A, 0x1B, 0x04, 0x5F, 0x2B, 0x05, 0xBC,
      0x39, 0x01, 0x09, 0x04, 0xB0, 0x00, 0x38, 0x00, 0xD4, 0x00, 0x00, 0x06, 0x01, 0x01, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x0A, 0x5D, 0xD4, 0x37, 0x20, 0x7E, 0x8E, 0x3F, 0x2B, 0xD4, 0x37, 0xA0, 0x7E, 0x0E,
      0xC0, 0x0C, 0x0F, 0x5B, 0x5D, 0xE4, 0x37, 0x00, 0x1E, 0x0E, 0x00, 0x61, 0x04, 0x7E, 0x24, 0x5A,
      0x14, 0x00, 0x00, 0x08, 0x00, 0x58, 0x00, 0xBC, 0x64, 0x5C, 0x23, 0x18, 0x8D, 0x04, 0x40, 0x97,
      0x04, 0x40, 0xA1, 0x04, 0x40, 0xAB, 0x04, 0x40, 0xB5, 0x04, 0x40, 0xBF, 0x04, 0x28, 0xC9, 0x04,
      0x60, 0xE7, 0x04, 0x58, 0xFB, 0x04, 0x08, 0x05, 0x14, 0x38, 0xD7, 0x14, 0x01, 0x00, 0x94, 0x00,
      0x94, 0x00, 0x58, 0x01, 0xF8, 0x38, 0xA0, 0x1E, 0x0E, 0x01, 0x00, 0x50, 0x00, 0x50, 0x00, 0x58,
      0x00, 0xE4, 0x37, 0x80, 0x1E, 0x0E, 0x7B, 0x01, 0xC0, 0x00, 0x04, 0x1E, 0x0E, 0x08, 0x3A, 0x00,
      0x7B, 0x02, 0xC0, 0x00, 0x08, 0x1E, 0x0E, 0x10, 0x28, 0x00, 0x0A, 0xEB, 0xEE, 0x1C, 0x29, 0x7E,
      0x0E, 0x3F, 0x1D, 0xEE, 0x1C, 0x69, 0x7E, 0x0E, 0xC0, 0x0C, 0x0F, 0x21, 0x00, 0xF9, 0x12, 0x0A,
      0x1E, 0x0E, 0x03, 0x00, 0x00, 0x00, 0x55, 0xCC, 0x14, 0x2A, 0x1E, 0x0E, 0x7B, 0x02, 0xC6, 0x17,
      0x0A, 0x1E, 0x0E, 0x10, 0x28, 0x00, 0x03, 0x00, 0x0A, 0x00, 0x0A, 0xDC, 0x16, 0x0A, 0x1E, 0x0E,
      0x0A, 0xEB, 0xDE, 0x17, 0x2A, 0x1E, 0x0E, 0x5B, 0xEB, 0xF0, 0x17, 0x0A, 0x7E, 0x0E, 0x00, 0x60,
      0x06, 0x0E, 0x24, 0x5A, 0x94, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x94, 0x64, 0x01, 0x00, 0x44,
      0x00, 0x44, 0x00, 0x00, 0x01, 0xC8, 0x19, 0xAA, 0x7E, 0x0E, 0x69, 0x07, 0xF0, 0x17, 0x0A, 0x1E,
      0x0E, 0x0B, 0x00, 0x01, 0x00, 0x50, 0x00, 0x50, 0x00, 0x00, 0x00, 0xF0, 0x17, 0x8A, 0x7E, 0x0E,
      0x1E, 0x01, 0xC2, 0x39, 0x0A, 0x5E, 0x0E, 0x1F, 0x20, 0xE0, 0x3B, 0x0A, 0x5E, 0x0E, 0x7B, 0x02,
      0xE0, 0x3B, 0x0A, 0x1E, 0x0E, 0x10, 0x28, 0x00, 0x1E, 0x01, 0xE2, 0x3B, 0x0A, 0x5E, 0x0E, 0x1F,
      0x20, 0xDA, 0x02, 0x0B, 0x5E, 0x0E, 0x7B, 0x03, 0xDA, 0x02, 0x0B, 0x1E, 0x0E, 0x16, 0x10, 0x00,
      0x1E, 0x01, 0xDB, 0x37, 0x0B, 0x5E, 0x0E, 0x1F, 0x20, 0xE3, 0x37, 0x0B, 0x5E, 0x0E, 0x7B, 0x03,
      0xE3, 0x37, 0x0B, 0x1E, 0x0E, 0x16, 0x10, 0x00, 0x0A, 0xDB, 0xC7, 0x39, 0x2B, 0x7E, 0x0E, 0x3F,
      0x1B, 0xC7, 0x39, 0x6B, 0x7E, 0x0E, 0xC0, 0x0C, 0x0F, 0x5B, 0xDB, 0xD2, 0x3A, 0x0B, 0x7E, 0x0E,
      0x00, 0x60, 0x06, 0x0E, 0x24, 0x5A, 0x84, 0x00, 0x00, 0x00, 0x00, 0x64, 0x00, 0x20, 0x64, 0x5C,
      0x11, 0x02, 0x40, 0x04, 0x18, 0x4A, 0x04, 0x16, 0x54, 0x04, 0x58, 0x5E, 0x04, 0x0C, 0x68, 0x04,
      0x01, 0x00, 0x20, 0x00, 0x20, 0x00, 0x60, 0x00, 0xD2, 0x3A, 0x4B, 0x7E, 0x0E, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xB4, 0x3A } ,

    { 0x3F, 0x10, 0xF0, 0x16, 0x42, 0x7C, 0x0E, 0xC0, 0x0C, 0x0F, 0x7B, 0x01, 0xC0, 0x00, 0x04, 0x1C,
      0x0E, 0x08, 0x3A, 0x00, 0x7B, 0x02, 0xC0, 0x00, 0x08, 0x1C, 0x0E, 0x10, 0x28, 0x00, 0x0A, 0x61,
      0xE6, 0x2E, 0x2A, 0x7C, 0x0E, 0x3F, 0x0C, 0xE6, 0x2E, 0x2A, 0x7C, 0x0E, 0xC0, 0x0C, 0x0F, 0x5B,
      0x61, 0xF9, 0x36, 0x0A, 0x7C, 0x0E, 0x14, 0x60, 0x06, 0x0E, 0x24, 0x5A, 0x00, 0x00, 0x7C, 0x00,
      0x00, 0x00, 0x00, 0x7C, 0x64, 0x01, 0x00, 0x7C, 0x00, 0x7C, 0x00, 0x00, 0x01, 0xF9, 0x36, 0x6A,
      0x7C, 0x0E, 0x69, 0x07, 0xF9, 0x36, 0x0A, 0x1C, 0x0E, 0x0B, 0x00, 0x7B, 0x03, 0xC0, 0x00, 0x0B,
      0x1C, 0x0E, 0x16, 0x10, 0x00, 0x7B, 0x04, 0xC0, 0x00, 0x0D, 0x1C, 0x0E, 0x1A, 0x22, 0x00, 0x0A,
      0x8A, 0xF0, 0x14, 0x2E, 0x7C, 0x0E, 0x3F, 0x11, 0xF0, 0x14, 0x4E, 0x7C, 0x0E, 0xC0, 0x0C, 0x0F,
      0x5B, 0x8A, 0xCB, 0x16, 0x0E, 0x7C, 0x0E, 0x28, 0x60, 0x04, 0x4C, 0x1E, 0x5A, 0x30, 0x00, 0xB0,
      0x00, 0x00, 0x10, 0x00, 0xD0, 0x64, 0x5C, 0x0E, 0x04, 0xB2, 0x04, 0x2A, 0xBC, 0x04, 0x28, 0xC6,
      0x04, 0x26, 0xD0, 0x04, 0x01, 0x00, 0x80, 0x00, 0x80, 0x00, 0x10, 0x01, 0xDF, 0x17, 0xAE, 0x7C,
      0x0E, 0x69, 0x0C, 0xCB, 0x16, 0x0E, 0x1C, 0x0E, 0x10, 0x00, 0x01, 0x00, 0x50, 0x00, 0x50, 0x00,
      0x10, 0x00, 0xCB, 0x16, 0x8E, 0x7C, 0x0E, 0x5B, 0x00, 0xCD, 0x28, 0x0E, 0x7C, 0x0E, 0x1E, 0x60,
      0x04, 0x4C, 0x1E, 0x5A, 0x00, 0x00, 0x84, 0x00, 0x00, 0x00, 0x00, 0x84, 0x64, 0x5C, 0x17, 0x1C,
      0x06, 0x04, 0x2A, 0x10, 0x04, 0x52, 0x1A, 0x04, 0x04, 0xC4, 0x04, 0x2A, 0xCE, 0x04, 0x28, 0xD8,
      0x04, 0x26, 0xE2, 0x04, 0x01, 0x00, 0x84, 0x00, 0x84, 0x00, 0xA0, 0x00, 0xCD, 0x28, 0x4E, 0x7C,
      0x0E, 0x0A, 0x62, 0xE2, 0x16, 0x31, 0x7C, 0x0E, 0x3F, 0x0C, 0xE2, 0x16, 0x51, 0x7C, 0x0E, 0xC0,
      0x0C, 0x0F, 0x7B, 0x05, 0xC0, 0x1E, 0x11, 0x1C, 0x0E, 0x23, 0x38, 0x00, 0x5B, 0x00, 0xE3, 0x00,
      0x12, 0x7C, 0x0E, 0x32, 0x60, 0x04, 0x4C, 0x23, 0x5A, 0x00, 0x00, 0xDC, 0x00, 0x00, 0x00, 0x00,
      0xDC, 0x64, 0x5C, 0x1D, 0x06, 0xBA, 0x04, 0x2A, 0xC4, 0x04, 0xA8, 0xCE, 0x04, 0x2A, 0xD8, 0x04,
      0x52, 0xE2, 0x04, 0x04, 0x8C, 0x14, 0x2A, 0x96, 0x14, 0x28, 0xA0, 0x14, 0x26, 0xAA, 0x14, 0x01,
      0x00, 0xDC, 0x00, 0xDC, 0x00, 0x24, 0x02, 0xE3, 0x00, 0x72, 0x7C, 0x0E, 0x5B, 0x00, 0xDB, 0x16,
      0x14, 0x7C, 0x0E, 0x14, 0x60, 0x04, 0xB0, 0x2B, 0x5A, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00,
      0x60, 0x64, 0x5C, 0x26, 0x18, 0x58, 0x04, 0x24, 0x62, 0x04, 0x26, 0x6C, 0x04, 0x24, 0x76, 0x04,
      0x24, 0x80, 0x04, 0x26, 0x8A, 0x04, 0x0C, 0x94, 0x04, 0x06, 0x48, 0x14, 0x2A, 0x52, 0x14, 0xA8,
      0x5C, 0x14, 0x2A, 0x66, 0x14, 0x52, 0x70, 0x14, 0x01, 0x00, 0x60, 0x00, 0x60, 0x00, 0x6C, 0x01,
      0xDC, 0x16, 0x74, 0x7C, 0x0E, 0x7B, 0x06, 0xC0, 0x1E, 0x14, 0x1C, 0x0E, 0x29, 0x28, 0x00, 0x5B,
      0x00, 0xC1, 0x0A, 0x15, 0x7C, 0x0E, 0x1E, 0x60, 0x04, 0xB0, 0x2B, 0x5A, 0x00, 0x00, 0x90, 0x00,
      0x00, 0x00, 0x00, 0x90, 0x64, 0x5C, 0x32, 0x1C, 0x1A, 0x04, 0x20, 0x24, 0x04, 0x20, 0x2E, 0x04,
      0x04, 0x38, 0x04, 0x18, 0x88, 0x04, 0x24, 0x92, 0x04, 0x26, 0x9C, 0x04, 0x24, 0xA6, 0x04, 0x24,
      0xB0, 0x04, 0x26, 0xBA, 0x04, 0x0C, 0xC4, 0x04, 0x06, 0x78, 0x14, 0x2A, 0x82, 0x14, 0xA8, 0x8C,
      0x14, 0x2A, 0x96, 0x14, 0x52, 0xA0, 0x14, 0x01, 0x00, 0x90, 0x00, 0x90, 0x00, 0x90, 0x01, 0xC1,
      0x0A, 0x75, 0x7C, 0x0E, 0x69, 0x15, 0xC1, 0x0A, 0x15, 0x1C, 0x0E, 0x00, 0x00, 0x5B, 0x00, 0xF0,
      0x11, 0x15, 0x7C, 0x0E, 0x14, 0x60, 0x04, 0xB0, 0x2B, 0x5A, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00,
      0x00, 0x60, 0x64, 0x5C, 0x38, 0x12, 0x03, 0x04, 0x14, 0x0D, 0x04, 0x1C, 0x21, 0x04, 0x20, 0x2B,
      0x04, 0x20, 0x35, 0x04, 0x04, 0x3F, 0x04, 0x18, 0x8F, 0x04, 0x24, 0x99, 0x04, 0x26, 0xA3, 0x04,
      0x24, 0xAD, 0x04, 0x24, 0xB7, 0x04, 0x26, 0xC1, 0x04, 0x0C, 0xCB, 0x04, 0x06, 0x7F, 0x14, 0x2A,
      0x89, 0x14, 0xA8, 0x93, 0x14, 0x2A, 0x9D, 0x14, 0x52, 0xA7, 0x14, 0x01, 0x00, 0x60, 0x00, 0x60,
      0x00, 0xAC, 0x00, 0xF0, 0x11, 0x55, 0x7C, 0x0E, 0x5B, 0x00, 0xDF, 0x17, 0x15, 0x7C, 0x0E, 0x19,
      0x60, 0x04, 0xB0, 0x2B, 0x5A, 0x00, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x78, 0x64, 0x5C, 0x38,
      0x86, 0x09, 0x04, 0x14, 0x13, 0x04, 0x1C, 0x27, 0x04, 0x20, 0x31, 0x04, 0x20, 0x3B, 0x04, 0x04,
      0x45, 0x04, 0x18, 0x95, 0x04, 0x24, 0x9F, 0x04, 0x26, 0xA9, 0x04, 0x24, 0xB3, 0x04, 0x24, 0xBD,
      0x04, 0x26, 0xC7, 0x04, 0x0C, 0xD1, 0x04, 0x06, 0x85, 0x14, 0x2A, 0x8F, 0x14, 0xA8, 0x99, 0x14,
      0x2A, 0xA3, 0x14, 0x52, 0xAD, 0x14, 0x01, 0x00, 0x78, 0x00, 0x78, 0x01, 0x18, 0x00, 0xDF, 0x17,
      0x55, 0x7C, 0x0E, 0x7B, 0x07, 0xC0, 0x1E, 0x15, 0x1C, 0x0E, 0x2B, 0x1C, 0x00, 0x7B, 0x00, 0xC0,
      0x00, 0x00, 0x1D, 0x0E, 0x00, 0x4C, 0x00, 0x07, 0x00, 0x00, 0x09, 0xAD, 0xDC, 0x0E, 0x00, 0x00,
      0x00, 0x6E, 0xDC, 0x0E, 0x09, 0x00, 0x74, 0x61, 0x8A, 0x04, 0x00, 0x00, 0x09, 0xAD, 0x04, 0x5F,
      0x2D, 0x05, 0x4E, 0x37, 0x00, 0xEB, 0x04, 0x7E, 0x00, 0x00, 0x00, 0xD0, 0x00, 0x00, 0x07, 0x00,
      0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x0A, 0x7D, 0xE4, 0x16, 0x21, 0x7D, 0x0E, 0x3F, 0x0F, 0xE4, 0x16,
      0xA1, 0x7D, 0x0E, 0xC0, 0x0C, 0x0F, 0x7B, 0x01, 0xC0, 0x00, 0x04, 0x1D, 0x0E, 0x08, 0x3A, 0x00,
      0x7B, 0x02, 0xC0, 0x00, 0x08, 0x1D, 0x0E, 0x10, 0x28, 0x00, 0x7B, 0x03, 0xC0, 0x00, 0x0B, 0x1D,
      0x0E, 0x16, 0x10, 0x00, 0x69, 0x07, 0xC0, 0x00, 0x0B, 0x1D, 0x0E, 0x2B, 0x00, 0x0A, 0xD3, 0xF0,
      0x00, 0x2B, 0x7D, 0x0E, 0x3F, 0x1A, 0xF0, 0x00, 0x6B, 0x7D, 0x0E, 0xC0, 0x0C, 0x0F, 0x5B, 0xD3,
      0xD5, 0x07, 0x0B, 0x7D, 0x0E, 0x0F, 0x60, 0x06, 0x0E, 0x24, 0x5A, 0x78, 0x00, 0x5C, 0x00, 0x00,
      0x00, 0x00, 0xD4, 0x64, 0x01, 0x00, 0x84, 0x00, 0x84, 0x00, 0x00, 0x01, 0xE9, 0x08, 0xAB, 0x7D,
      0x0E, 0x01, 0x00, 0x50, 0x00, 0x50, 0x00, 0x00, 0x00, 0xD5, 0x07, 0x8B, 0x7D, 0x0E, 0x5B, 0x00,
      0xEF, 0x26, 0x0B, 0x7D, 0x0E, 0x1E, 0x60, 0x06, 0x0E, 0x24, 0x5A, 0x00, 0x00, 0xB8, 0x00, 0x00,
      0x00, 0x00, 0xB8, 0x64, 0x5C, 0x0E, 0x14, 0x04, 0x04, 0x2C, 0x0E, 0x04, 0x2C, 0x18, 0x04, 0x68,
      0x22, 0x04, 0x01, 0x00, 0xB8, 0x00, 0xB8, 0x00, 0xCC, 0x00, 0xEF, 0x26, 0x4B, 0x7D, 0x0E, 0x7B,
      0x04, 0xC0, 0x00, 0x0D, 0x1D, 0x0E, 0x1A, 0x22, 0x00, 0x5B, 0x00, 0xE5, 0x38, 0x0D, 0x7D, 0x0E,
      0x14, 0x60, 0x04, 0x4C, 0x1E, 0x5A, 0x00, 0x00, 0x58, 0x00, 0x00, 0x00, 0x00, 0x58, 0x64, 0x5C,
      0x0E, 0xCC, 0x8E, 0x04, 0x2C, 0x98, 0x04, 0x2C, 0xA2, 0x04, 0x68, 0xAC, 0x04, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xCE, 0xA9 }
 };

  if (historyLine == 0x0F) line[0] = 0x90;
  else line[0] = historyLine + 1;

  if (historyPage == 0x0000) memcpy(&line[1],&histPages[0][64*historyLine],64);
  else memcpy(&line[1],&histPages[1][64*historyLine],64);

  historyLine++;
  
}
